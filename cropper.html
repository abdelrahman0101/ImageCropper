<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="utf-8">
    <title>Image Cropper</title>
    <style>
        #cnvs {
            border: 2px solid black;
            display: block;
        }

        #file_importer {
            display: none;
        }

        main {
            display: flex;
            gap: 10px;
        }

        #controls {
            display: flex;
            flex-direction: column;
            width: 200px;
            gap: 10px;
        }

        .toolOptions,
        #toolButtons {
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header></header>
    <main>
        <canvas width="400" height="300" id="cnvs"></canvas>
        <div id="controls">
            <input type="file" id="file_importer" accept="image/*">
            <button id="btnUpload">Upload Image</button>
            <div id="toolButtons">
                <button id="btnCrop" class="tool">Crop</button>
            </div>
            <div id="cropTool" class="toolOptions">
                <label>Selection mode:</label>
                <label>
                    <input type="radio" name="selection" value="rectangle" >
                    Rectangle
                </label>
                <label>
                    <input type="radio" name="selection" value="ellipse">
                    Ellipse
                </label>
                <label>
                    <input type="radio" name="selection" value="free" checked>
                    Free form
                </label>
                <button id="btnReset">Reset</button>
                <button id="btnSave">Save</button>
            </div>
        </div>

    </main>
    <footer></footer>
    <script>
        function Path() {
            this.points = [];
            this.minX = Infinity;
            this.minY = Infinity;
            this.maxX = -Infinity;
            this.maxY = -Infinity;
            this.addPoint = function (x, y) {
                this.points.push({ x: x, y: y });
                this.minX = Math.min(this.minX, x);
                this.minY = Math.min(this.minY, y);
                this.maxX = Math.max(this.maxX, x);
                this.maxY = Math.max(this.maxY, y);
            }
            this.getHeight = function () {
                return this.maxY - this.minY;
            }
            this.getWidth = function () {
                return this.maxX - this.minX;
            }
        }

        let img = null;
        let editMode = "upload";
        let cnvs = document.querySelector("#cnvs");
        let ctx = cnvs.getContext("2d");
        ctx.setLineDash([5, 3]);
        ctx.strokeStyle = "blue";
        let drawing = false;
        let open = false;
        let path = new Path();

        cnvs.addEventListener("pointerdown", (e) => {
            if (editMode != "crop") {
                return;
            }
            let x = e.clientX - cnvs.getBoundingClientRect().left;
            let y = e.clientY - cnvs.getBoundingClientRect().top;
            ctx.globalCompositeOperation = "source-over";
            drawing = true;
            let cropMode = document.querySelector("input:checked").value;
            
            if (cropMode == "free") {
                path.addPoint(x, y);
                if (!open) {
                    //draw a starting point
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.fillStyle = "white";
                    ctx.fill();
                    //open a new path
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    open = true;
                } else {
                    //draw a new segment
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
            }

        });

        cnvs.addEventListener("pointermove", (e) => {
            if (drawing) {
                let x = e.clientX - cnvs.getBoundingClientRect().left;
                let y = e.clientY - cnvs.getBoundingClientRect().top;
                let cropMode = document.querySelector("input:checked").value;
                if (cropMode == "free")
                {
                    path.addPoint(x, y);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
            }
        });

        cnvs.addEventListener("pointerup", (e) => {
            let x = e.clientX - cnvs.getBoundingClientRect().left;
            let y = e.clientY - cnvs.getBoundingClientRect().top;
            if (path.getHeight() > 20 && path.getWidth() > 20 &&  //large area
                Math.abs(x - path.points[0].x) < 10 && Math.abs(y - path.points[0].y) < 10) //close to starting point
            {
                //path is closed
                open = false;
                //reload image to erase selection path
                reloadImage();
                ctx.beginPath();
                ctx.moveTo(path.points[0].x, path.points[0].y);
                for (let p of path.points) {
                    ctx.lineTo(p.x, p.y);
                }
                //fill and keep intersection area of the drawn image
                ctx.globalCompositeOperation = "destination-in";
                ctx.fill();
                path = new Path();
            }
            drawing = false;
        });

        function finishDrawing() {

        }

        function reloadImage() {
            if (img != null) {
                ctx.globalCompositeOperation = "source-over";
                ctx.clearRect(0, 0, cnvs.clientWidth, cnvs.clientHeight);
                ctx.drawImage(img, 0, 0);
            }
        }

        document.querySelector("#file_importer").addEventListener("change", (e) => {
            const file_url = e.target.files[0];
            const fileReader = new FileReader();
            fileReader.onload = function () {
                img = new Image;
                img.onload = function () {
                    ctx.clearRect(0, 0, cnvs.clientWidth, cnvs.clientHeight);
                    ctx.globalCompositeOperation = "source-over";
                    ctx.drawImage(img, 0, 0);
                    img.onload = null;
                    showTools();
                };
                img.src = fileReader.result;
            }
            fileReader.readAsDataURL(file_url);
        });

        document.querySelector("#btnUpload").addEventListener("click", () => {
            document.querySelector("#file_importer").click();
        });

        document.querySelector("#btnCrop").addEventListener("click", () => {
            hideTools();
            document.querySelector("#cropTool").style.display = "flex";
            editMode = "crop";
        });

        document.querySelector("#btnReset").addEventListener("click", () => {
            reloadImage();
        });

        document.querySelector("#btnSave").addEventListener("click", () => {
            let w = path.maxX - path.minX;
            let h = path.maxY - path.minY;
            let cropped = ctx.getImageData(path.minX, path.minY, w, h);
            let out_cnvs = document.createElement("canvas");
            out_cnvs.width = w;
            out_cnvs.height = h;
            out_cnvs.getContext("2d").putImageData(cropped, 0, 0);

        });

        function showTools() {
            document.querySelector("#btnUpload").style.display = "none";
            document.querySelector("#toolButtons").style.display = "flex";
        }

        function hideTools() {
            document.querySelector("#toolButtons").style.display = "none";
        }


    </script>
</body>

</html>